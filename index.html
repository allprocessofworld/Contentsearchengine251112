<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ì—… ë‹¤í ë¦¬ì„œì¹˜ íˆ´</title>
    <!-- 1. Tailwind CSS (CDN) ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 2. í…Œì´ë¸” ì…€ì´ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆë˜ë„ë¡ ìˆ˜ì • */
        td {
            overflow-wrap: break-word;
        }
    </style>
</head>
<!-- 6. body í…Œë§ˆ ë³€ê²½ (dark -> light) -->
<body class="bg-white text-gray-900 font-sans">

    <!-- 1. max-w-7xl, mx-auto ì œê±° -> w-full, p-4 md:p-8 ì¶”ê°€ (ì „ì²´ ë„ˆë¹„ ë ˆì´ì•„ì›ƒ) -->
    <div class="w-full p-4 md:p-8">
        <!-- 6. h1 ìƒ‰ìƒ ë³€ê²½ -->
        <h1 class="text-3xl font-bold text-blue-600 mb-6">ğŸ­ ì‚°ì—… ë‹¤í ë¦¬ì„œì¹˜ íˆ´ (Web Program Ver.)</h1>

        <!-- 6. div í…Œë§ˆ ë³€ê²½ -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-lg mb-8">
            <!-- 6. h2 ìƒ‰ìƒ ë³€ê²½ -->
            <h2 class="text-xl font-semibold mb-4 text-gray-900">1. YouTube ì˜ìƒ ê²€ìƒ‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 6. input/select í…Œë§ˆ ë³€ê²½ -->
                <input type="text" id="keywordInput" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ (ì˜ˆ: ìŠ¤ë§ˆíŠ¸íŒ©í† ë¦¬)" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="dateRangeSelect" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">ê²Œì‹œì¼ (ì „ì²´)</option>
                    <option value="7d">ìµœê·¼ 1ì£¼ì¼</option>
                    <option value="30d">ìµœê·¼ 1ê°œì›”</option>
                    <option value="90d">ìµœê·¼ 3ê°œì›”</option>
                    <option value="180d">ìµœê·¼ 6ê°œì›”</option>
                    <option value="365d">ìµœê·¼ 1ë…„</option>
                </select>
                <input type="number" id="maxResultsInput" placeholder="ê²€ìƒ‰í•  ì˜ìƒ ìˆ˜ (ìµœëŒ€ 50)" value="50" max="50" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <!-- 6. ë²„íŠ¼ì€ ê·¸ëŒ€ë¡œ (íŒŒë€ìƒ‰ ìœ ì§€) -->
            <button id="searchButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                ê²€ìƒ‰ ì‹¤í–‰
            </button>
        </div>

        <!-- ê³µí†µ ë©”ì‹œì§€ ë° ë¡œë”© ì˜ì—­ -->
        <div id="loadingIndicator" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <!-- 6. ë¡œë”© í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ -->
            <p class="text-gray-900 text-lg mt-4 text-center">ì²˜ë¦¬ ì¤‘...</p>
        </div>
        <!-- 6. ë©”ì‹œì§€ ë°•ìŠ¤ í…Œë§ˆ ë³€ê²½ -->
        <div id="messageBox" class="hidden p-4 mb-4 text-sm text-yellow-800 bg-yellow-100 border border-yellow-200 rounded-lg" role="alert"></div>

        <!-- 6. div í…Œë§ˆ ë³€ê²½ -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-lg mb-8">
            <!-- 6. h2 ìƒ‰ìƒ ë³€ê²½ -->
            <h2 class="text-xl font-semibold mb-4 text-gray-900">2. YouTube ê²€ìƒ‰ ê²°ê³¼</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="resultsTable">
                    <!-- 6. a. <thead> í…Œë§ˆ ë³€ê²½ -->
                    <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
                        <tr>
                            <th class="p-3"><input type="checkbox" id="selectAllCheckbox" class="w-6 h-6"></th>
                            <!-- 1. ì¸ë„¤ì¼ ì—´ w-[300px]ë¡œ ë³€ê²½ -->
                            <th class="p-3 w-[300px]">ì¸ë„¤ì¼</th>
                            <!-- 2. ì œëª© ì—´ ë„ˆë¹„ í´ë˜ìŠ¤ ì œê±° (ìë™ ëŠ˜ì–´ë‚¨) -->
                            <th class="p-3 cursor-pointer hover:bg-gray-300" onclick="sortTable(2)">ì œëª© â–¼</th>
                            <th class="p-3 w-1/6 cursor-pointer hover:bg-gray-300" onclick="sortTable(3)">ì±„ë„ëª… â–¼</th>
                            <!-- 3. ì¡°íšŒìˆ˜/êµ¬ë…ì/ë¹„ìœ¨ ì—´ w-24ë¡œ ì¤„ì´ê¸° -->
                            <th class="p-3 w-24 cursor-pointer hover:bg-gray-300" onclick="sortTable(4)">ì¡°íšŒìˆ˜ â–¼</th>
                            <th class="p-3 w-24 cursor-pointer hover:bg-gray-300" onclick="sortTable(5)">êµ¬ë…ì â–¼</th>
                            <th class="p-3 w-24 cursor-pointer hover:bg-gray-300" onclick="sortTable(6)">ë¹„ìœ¨ (V/S) â–¼</th>
                            <!-- 4. ê²Œì‹œì¼ ì—´ w-40ë¡œ ëŠ˜ë¦¬ê¸° -->
                            <th class="p-3 w-40 cursor-pointer hover:bg-gray-300" onclick="sortTable(7)">ê²Œì‹œì¼ â–¼</th>
                            <th class="p-3 w-24">ë§í¬</th>
                        </tr>
                    </thead>
                    <!-- 6. b. <tbody> í…Œë§ˆ ë³€ê²½ -->
                    <tbody id="resultsBody" class="divide-y divide-gray-200">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 6. div í…Œë§ˆ ë³€ê²½ -->
        <div class="bg-gray-100 p-6 rounded-lg shadow-lg">
            <!-- 6. h2 ìƒ‰ìƒ ë³€ê²½ -->
            <h2 class="text-xl font-semibold mb-4 text-gray-900">3. ì£¼ì œ ë¶„ì„ ë° ì—…ì²´ ì„­ì™¸ ë¦¬ìŠ¤íŠ¸</h2>
            <!-- 12. ë‘ ë²„íŠ¼ì„ í•˜ë‚˜ë¡œ í†µí•©í•˜ì—¬ ì‚¬ìš©ì ì˜¤ë¥˜(ì›Œí¬í”Œë¡œìš°) ê°œì„  -->
            <div class="flex gap-4 mb-4">
                <button id="processSelectedButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                    ì„ íƒ ì˜ìƒ [ë¶„ì„] ë° [ì—…ì²´ ê²€ìƒ‰] ë™ì‹œ ì‹¤í–‰
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="analysisTable">
                    <!-- 6. c. <thead> í…Œë§ˆ ë³€ê²½ -->
                    <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
                        <tr>
                            <th class="p-3">ì˜ìƒ ì œëª©</th>
                            <th class="p-3">AI ë¶„ì„ - í•µì‹¬ ì£¼ì œ</th>
                            <th class="p-3">AI ë¶„ì„ - ê´€ë ¨ ì‚°ì—…/ì—…ì¢…</th>
                            <th class="p-3">ì„­ì™¸ ëŒ€ìƒ ê¸°ì—… (Top 5)</th>
                        </tr>
                    </thead>
                    <!-- 6. d. <tbody> í…Œë§ˆ ë³€ê²½ -->
                    <tbody id="analysisBody" class="divide-y divide-gray-200">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. Vanilla JavaScript (Client Logic) -->
    <script>
        // --- DOM ìš”ì†Œ ---
        const keywordInput = document.getElementById('keywordInput');
        // 2. 'publishedAfterInput' ì œê±°, 'dateRangeSelect' ì¶”ê°€
        const dateRangeSelect = document.getElementById('dateRangeSelect');
        const maxResultsInput = document.getElementById('maxResultsInput');
        const searchButton = document.getElementById('searchButton');
        const resultsBody = document.getElementById('resultsBody');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        // 12. ë²„íŠ¼ ë¡œì§ ë³€ê²½
        const processSelectedButton = document.getElementById('processSelectedButton');
        const analysisBody = document.getElementById('analysisBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            // ìƒ‰ìƒ ë³€ê²½ (ë‚˜ì¤‘ì— ì¶”ê°€)
        }

        // --- 1. YouTube ê²€ìƒ‰ (Backend API í˜¸ì¶œ) ---
        searchButton.addEventListener('click', async () => {
            const keyword = keywordInput.value;
            // 3. 'dateRangeSelect' ê°’ìœ¼ë¡œ 'publishedAfter' ë‚ ì§œ ê³„ì‚°
            const dateRange = dateRangeSelect.value;
            let publishedAfter = null;
            if (dateRange) {
                const days = parseInt(dateRange.replace('d', ''));
                const date = new Date();
                date.setDate(date.getDate() - days);
                publishedAfter = date.toISOString();
            }
            const maxResults = maxResultsInput.value;

            if (!keyword) {
                showMessage("ê²€ìƒ‰ í‚¤ì›Œë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.", "error");
                return;
            }

            showLoading(true);
            showMessage("YouTube API í˜¸ì¶œ ì¤‘...", "info");

            try {
                // (ì¤‘ìš”) Google APIê°€ ì•„ë‹Œ, ìš°ë¦¬ ìì‹ ì˜ Vercel ë°±ì—”ë“œ(/api/youtube)ë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 3. 'publishedAfter'ë¥¼ APIë¡œ ì „ì†¡
                    body: JSON.stringify({ keyword, publishedAfter, maxResults })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                const videos = await response.json();
                
                // (ê²½ê³ ) ìš”ì²­í•˜ì‹  ë³µì¡í•œ í•„í„°(êµ¬ë…ì, ìˆí¼/ë¡±í¼)ëŠ” API í• ë‹¹ëŸ‰(Quota)ì„ 
                // í­ë°œì‹œí‚¤ë¯€ë¡œ ì˜ë„ì ìœ¼ë¡œ 'ì œì™¸'í–ˆìŠµë‹ˆë‹¤. 
                // ëŒ€ì‹ , ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ HTML í…Œì´ë¸”ì—ì„œ 'ì •ë ¬'í•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
                
                displayResults(videos);
                showMessage("ê²€ìƒ‰ ì™„ë£Œ.", "success");

            } catch (error) {
                showMessage(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        });

        // --- 1.2. ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ---
        function displayResults(videos) {
            resultsBody.innerHTML = ''; // í…Œì´ë¸” ë¹„ìš°ê¸°
            videos.forEach(video => {
                const tr = document.createElement('tr');
                // 6. hover ìƒ‰ìƒ ë³€ê²½
                tr.classList.add('hover:bg-gray-100');
                
                // ë°ì´í„°ë¥¼ trì˜ datasetì— ì €ì¥ (ë‚˜ì¤‘ì— ë¶„ì„ìš©)
                tr.dataset.videoId = video.videoId;
                tr.dataset.title = video.title;
                tr.dataset.description = video.description;
                // 11. ì •ë ¬ì„ ìœ„í•œ ë°ì´í„° ì €ì¥
                tr.dataset.channel = video.channelTitle;
                tr.dataset.views = video.viewCount;
                tr.dataset.subs = video.subscriberCount;
                tr.dataset.published = video.publishedAt;
                
                // 4. ë¹„ìœ¨ ê³„ì‚°
                const viewCount = parseInt(video.viewCount || 0);
                const subCount = parseInt(video.subscriberCount || 0);
                const ratio = subCount > 0 ? (viewCount / subCount) : 0;
                tr.dataset.ratio = ratio;

                tr.innerHTML = `
                    <!-- 6. ì²´í¬ë°•ìŠ¤ í…Œë§ˆ ë³€ê²½ -->
                    <td class="p-3"><input type="checkbox" class="result-checkbox bg-gray-200 border-gray-300 rounded w-6 h-6"></td>
                    <!-- 1. ì¸ë„¤ì¼ <img> í¬ê¸° ì¡°ì • (w-full, h-auto) -->
                    <td class="p-3"><img src="${video.thumbnail}" alt="Thumbnail" class="w-full h-auto rounded"></td>
                    <!-- 2. ì œëª© tdì— ìë™ ì¤„ë°”ê¿ˆ í´ë˜ìŠ¤ ì¶”ê°€ -->
                    <td class="p-3 whitespace-normal">${video.title}</td>
                    <td class="p-3">${video.channelTitle}</td>
                    <!-- 5. ì¡°íšŒìˆ˜ 'íšŒ' ì¶”ê°€ -->
                    <td class="p-3">${viewCount.toLocaleString()}íšŒ</td>
                    <!-- 6. êµ¬ë…ì 'ëª…' ì¶”ê°€ -->
                    <td class="p-3">${subCount.toLocaleString()}ëª…</td>
                    <!-- 4. ë¹„ìœ¨ í‘œì‹œ -->
                    <td class="p-3">${ratio.toFixed(1)}x</td>
                    <td class="p-3">${new Date(video.publishedAt).toLocaleDateString()}</td>
                    <!-- 4. ë§í¬ tdì— ë„ˆë¹„ w-24, ìƒ‰ìƒ ë³€ê²½ -->
                    <td class="p-3 w-24"><a href="${video.videoUrl}" target="_blank" class="text-blue-600 hover:underline">ë§í¬</a></td>
                `;
                resultsBody.appendChild(tr);
            });
        }
        
        // --- 1.3. ì „ì²´ ì„ íƒ ---
        selectAllCheckbox.addEventListener('click', () => {
            document.querySelectorAll('.result-checkbox').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        });

        // --- 12. í†µí•© ë²„íŠ¼ (ë¶„ì„ + ì—…ì²´ ê²€ìƒ‰) ë¡œì§ ---
        processSelectedButton.addEventListener('click', async () => {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                showMessage("ë¨¼ì € ë¶„ì„í•  ì˜ìƒì„ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.", "error");
                return;
            }

            showLoading(true);
            analysisBody.innerHTML = ''; // ë¶„ì„ í…Œì´ë¸” ë¹„ìš°ê¸°
            showMessage(`ì´ ${selectedRows.length}ê°œ í•­ëª© ë¶„ì„ ë° ê²€ìƒ‰ ì‹œì‘...`);

            // í•œ ë²ˆì— í•˜ë‚˜ì”© ìˆœì°¨ ì²˜ë¦¬ (API ê³¼ë¶€í•˜ ë°©ì§€)
            for (const row of selectedRows) {
                const { title, description } = row.dataset;
                let analysisData = null;
                let companyData = null;

                try {
                    // --- A. AI ì£¼ì œ ë¶„ì„ ---
                    showMessage(`[1/2] "${title}" ì˜ìƒ AI ë¶„ì„ ì¤‘...`);
                    const analyzeResponse = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: `ì œëª©: ${title}\nì„¤ëª…: ${description}` })
                    });
                    
                    if (!analyzeResponse.ok) {
                        // 7. ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´, ì„œë²„ê°€ ë³´ë‚¸ JSON ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼
                        // 'throw'í•˜ì—¬ catch ë¸”ë¡ìœ¼ë¡œ ë³´ëƒ…ë‹ˆë‹¤.
                        const err = await analyzeResponse.json();
                        throw new Error(err.error || 'AI ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨');
                    }
                    analysisData = await analyzeResponse.json(); // { topics: [], industries: [] }

                    // --- B. ì—…ì²´ ê²€ìƒ‰ ---
                    // 7. analysisDataê°€ ìœ íš¨í•œì§€, industriesê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (!analysisData.industries || analysisData.industries.length === 0 || analysisData.industries[0] === 'ë¶„ì„ ì‹¤íŒ¨') {
                        throw new Error('AIê°€ ìœ íš¨í•œ ì—…ì¢…ì„ ë°˜í™˜í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }

                    const industryQuery = analysisData.industries[0]; // ì²« ë²ˆì§¸ ì—…ì¢…ìœ¼ë¡œ ê²€ìƒ‰
                    showMessage(`[2/2] "${industryQuery}" ê´€ë ¨ ì—…ì²´ ê²€ìƒ‰ ì¤‘...`);
                    
                    const companyResponse = await fetch('/api/company', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: `${industryQuery} ëŒ€í•œë¯¼êµ­ ì œì¡° ê¸°ì—…` })
                    });

                    if (!companyResponse.ok) {
                        const err = await companyResponse.json();
                        throw new Error(err.error || 'ê¸°ì—… ê²€ìƒ‰ API í˜¸ì¶œ ì‹¤íŒ¨');
                    }
                    companyData = await companyResponse.json(); // { companies: [] }

                    // --- C. ê²°ê³¼ í…Œì´ë¸”ì— í–‰ ì¶”ê°€ ---
                    const analysisTR = document.createElement('tr');
                    analysisTR.innerHTML = `
                        <td class="p-3">${title}</td>
                        <td class="p-3">${analysisData.topics.join(', ')}</td>
                        <td class="p-3">${analysisData.industries.join(', ')}</td>
                        <td class="p-3">${formatCompanyList(companyData.companies)}</td>
                    `;
                    analysisBody.appendChild(analysisTR);
                    
                } catch (error) {
                    // ì˜¤ë¥˜ê°€ ë°œìƒí•´ë„ ë‹¤ìŒ í–‰ì€ ê³„ì† ì²˜ë¦¬
                    // 7. ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ 'error.message'ë¡œ ëª…í™•í•˜ê²Œ í‘œì‹œ
                    showMessage(`"${title}" ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "error");
                    const errorTR = document.createElement('tr');
                    errorTR.innerHTML = `
                        <td class="p-3">${title}</td>
                        <!-- 6. ì˜¤ë¥˜ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ë³€ê²½ -->
                        <td class="p-3" colspan="3"><span class="text-red-600">ì˜¤ë¥˜: ${error.message}</span></td>
                    `;
                    analysisBody.appendChild(errorTR);
                }
            }
            showMessage("ëª¨ë“  ì„ íƒ í•­ëª© ì²˜ë¦¬ ì™„ë£Œ.", "success");
            showLoading(false);
        });

        // 12. ì—…ì²´ ë¦¬ìŠ¤íŠ¸ í¬ë§·íŒ… í—¬í¼
        function formatCompanyList(companies) {
            if (!companies || companies.length === 0) {
                return 'ê²€ìƒ‰ëœ ê¸°ì—… ì—†ìŒ';
            }
            return companies.map(c => 
                /* 6. ë§í¬ ìƒ‰ìƒ ë³€ê²½ */
                `<div><a href="${c.link}" target="_blank" class="text-blue-600 hover:underline">${c.title}</a></div>`
            ).join('');
        }

        // --- í—¬í¼ í•¨ìˆ˜ ---
        function getSelectedRows() {
            return Array.from(document.querySelectorAll('.result-checkbox:checked'))
                        .map(cb => cb.closest('tr'));
        }
        
        // --- 11. í…Œì´ë¸” ì •ë ¬ (JS ê¸°ë°˜) ---
        // ì •ë ¬ ìƒíƒœë¥¼ ì €ì¥í•  ë³€ìˆ˜
        let sortDirections = {};

        function sortTable(columnIndex) {
            const tableBody = document.getElementById('resultsBody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            // í˜„ì¬ ì •ë ¬ ë°©í–¥ ê²°ì • (ê¸°ë³¸: ë‚´ë¦¼ì°¨ìˆœ)
            const currentDirection = sortDirections[columnIndex] || 'desc';
            const newDirection = currentDirection === 'desc' ? 'asc' : 'desc';
            sortDirections[columnIndex] = newDirection;

            // ì •ë ¬ ê¸°ì¤€ì´ ë˜ëŠ” dataset key
            const keys = [
                null, // 0. ì²´í¬ë°•ìŠ¤
                null, // 1. ì¸ë„¤ì¼
                'title', // 2. ì œëª©
                'channel', // 3. ì±„ë„ëª…
                'views', // 4. ì¡°íšŒìˆ˜
                'subs', // 5. êµ¬ë…ì
                'ratio', // 6. ë¹„ìœ¨
                'published', // 7. ê²Œì‹œì¼
                null // 8. ë§í¬
            ];
            const sortKey = keys[columnIndex];
            if (!sortKey) return; // ì •ë ¬ ë¶ˆê°€ëŠ¥í•œ ì—´

            // í—¤ë” í™”ì‚´í‘œ ì—…ë°ì´íŠ¸
            updateSortArrows(columnIndex, newDirection);
            
            rows.sort((a, b) => {
                const aVal = a.dataset[sortKey];
                // *** BUG FIX (ì´ì „ ìˆ˜ì • ë°˜ì˜ë¨): 'b.dataset[key]' -> 'b.dataset[sortKey]' ***
                const bVal = b.dataset[sortKey];

                let compareVal = 0;
                
                // ìˆ«ì/ë‚ ì§œ vs ë¬¸ìì—´ êµ¬ë¶„
                if (sortKey === 'views' || sortKey === 'subs' || sortKey === 'ratio') {
                    compareVal = parseFloat(aVal) - parseFloat(bVal);
                } else if (sortKey === 'published') {
                    compareVal = new Date(aVal) - new Date(bVal);
                } else {
                    compareVal = aVal.localeCompare(bVal); // ë¬¸ìì—´
                }

                return newDirection === 'asc' ? compareVal : -compareVal;
            });

            // ì •ë ¬ëœ í–‰ì„ ë‹¤ì‹œ ì‚½ì…
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        }
        
        function updateSortArrows(activeIndex, direction) {
            const headers = document.querySelectorAll("#resultsTable thead th");
            headers.forEach((th, index) => {
                // 6. hover ìƒ‰ìƒì— ë§ê²Œ í—¤ë” í™”DNI í…ìŠ¤íŠ¸ ìœ ì§€
                let textContent = th.textContent;
                if (th.onclick) {
                    textContent = th.textContent.replace(' â–¼', '').replace(' â–²', '');
                    if (index === activeIndex) {
                        textContent += (direction === 'asc' ? ' â–²' : ' â–¼');
                    } else {
                        textContent += ' â–¼'; // ê¸°ë³¸ê°’
                    }
                }
                th.textContent = textContent;
            });
        }

    </script>
</body>
</html>
