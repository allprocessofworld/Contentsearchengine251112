<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>허슬플레이 콘텐츠 검색기 (Vr.251112)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 로딩 스피너 스타일 */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 2. 테이블 셀이 단어 단위로 줄바꿈되도록 수정 */
        td {
            overflow-wrap: break-word;
        }
    </style>
</head>
<body class="bg-white text-gray-900 font-sans">

    <div class="w-full p-4 md:p-8">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">허슬플레이 콘텐츠 검색기 (Vr.251112)</h1>

        <div class="bg-gray-100 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">1. YouTube 영상 검색</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="keywordInput" placeholder="검색 키워드 (예: 스마트팩토리)" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="dateRangeSelect" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">게시일 (전체)</option>
                    <option value="7d">최근 1주일 업로드</option>
                    <option value="30d">최근 1개월 업로드</option>
                    <option value="90d">최근 3개월 업로드</option>
                    <option value="180d">최근 6개월 업로드</option>
                    <option value="365d">최근 1년 업로드</option>
                </select>
                <input type="number" id="maxResultsInput" placeholder="검색 결과 50개" value="50" max="50" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <h3 class="text-lg font-semibold mt-6 mb-4 text-gray-800">검색 후 필터링 (선택 사항)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <select id="viewCountFilter" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="0">조회수 (전체)</option>
                    <option value="100000">10만회 이상</option>
                    <option value="300000">30만회 이상</option>
                    <option value="500000">50만회 이상</option>
                    <option value="1000000">100만회 이상</option>
                </select>
                <select id="subscriberFilter" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="-1">구독자수 (전체)</option>
                    <option value="99999">10만명 미만</option>
                    <option value="100000">10만명 이상</option>
                    <option value="500000">50만명 이상</option>
                    <option value="1000000">100만명 이상</option>
                </select>
                <select id="ratioFilter" class="bg-white text-gray-900 p-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="0.0">비율(V/S) (전체)</option>
                    <option value="1.0">1.0x 이상</option>
                    <option value="2.0">2.0x 이상</option>
                    <option value="5.0">5.0x 이상</option>
                    <option value="10.0">10.0x 이상</option>
                    <option value="50.0">50.0x 이상</option>
                    <option value="100.0">100.0x 이상</option>
                </select>
            </div>

            <button id="searchButton" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                검색 실행
            </button>
        </div>

        <div id="loadingIndicator" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p class="text-gray-900 text-lg mt-4 text-center">처리 중...</p>
        </div>
        <div id="messageBox" class="hidden p-4 mb-4 text-sm text-yellow-800 bg-yellow-100 border border-yellow-200 rounded-lg" role="alert"></div>

        <div class="bg-gray-100 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">2. YouTube 검색 결과</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="resultsTable">
                    <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
                        <tr>
                            <th class="p-3"><input type="checkbox" id="selectAllCheckbox" class="w-6 h-6"></th>
                            <th class="p-3 w-[300px]">썸네일</th>
                            <th class="p-3 cursor-pointer hover:bg-gray-300" onclick="sortTable(2)">제목 ▼</th>
                            <th class="p-3 w-40 cursor-pointer hover:bg-gray-300" onclick="sortTable(3)">채널명 ▼</th>
                            <th class="p-3 w-32 cursor-pointer hover:bg-gray-300" onclick="sortTable(4)">조회수 ▼</th>
                            <th class="p-3 w-36 cursor-pointer hover:bg-gray-300" onclick="sortTable(5)">구독자 ▼</th>
                            <th class="p-3 w-32 cursor-pointer hover:bg-gray-300" onclick="sortTable(6)">비율 (V/S) ▼</th>
                            <th class="p-3 w-32 cursor-pointer hover:bg-gray-300" onclick="sortTable(7)">게시일 ▼</th>
                            <th class="p-3 w-24">링크</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bg-gray-100 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-900">3. 주제 분석 및 업체 섭외 리스트</h2>
            <div class="flex gap-4 mb-4">
                <button id="processSelectedButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                    선택 영상 [핵심 주제 및 소재] 분석
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="analysisTable">
                    <thead class="bg-gray-200 text-gray-700 uppercase text-sm">
                        <tr>
                            <th class="p-3">영상 제목</th>
                            <th class="p-3">핵심 주제 및 소재 (AI 분석)</th>
                        </tr>
                    </thead>
                    <tbody id="analysisBody" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- DOM 요소 ---
        const keywordInput = document.getElementById('keywordInput');
        // 2. 'publishedAfterInput' 제거, 'dateRangeSelect' 추가
        const dateRangeSelect = document.getElementById('dateRangeSelect');
        const maxResultsInput = document.getElementById('maxResultsInput');
        
        // 3, 4, 6. 필터 DOM 요소 추가
        const viewCountFilter = document.getElementById('viewCountFilter');
        const subscriberFilter = document.getElementById('subscriberFilter');
        const ratioFilter = document.getElementById('ratioFilter');
        
        const searchButton = document.getElementById('searchButton');
        const resultsBody = document.getElementById('resultsBody');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        // 12. 버튼 로직 변경
        const processSelectedButton = document.getElementById('processSelectedButton');
        const analysisBody = document.getElementById('analysisBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        // --- 유틸리티 함수 ---
        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            // 색상 변경 (나중에 추가)
        }

        // --- 1. YouTube 검색 (Backend API 호출) ---
        searchButton.addEventListener('click', async () => {
            const keyword = keywordInput.value;
            // 3. 'dateRangeSelect' 값으로 'publishedAfter' 날짜 계산
            const dateRange = dateRangeSelect.value;
            let publishedAfter = null;
            if (dateRange) {
                const days = parseInt(dateRange.replace('d', ''));
                const date = new Date();
                date.setDate(date.getDate() - days);
                publishedAfter = date.toISOString();
            }
            const maxResults = maxResultsInput.value;

            if (!keyword) {
                showMessage("검색 키워드는 필수입니다.", "error");
                return;
            }

            // 3, 4, 6. 필터 값 읽기
            const filters = {
                viewCount: parseInt(viewCountFilter.value),
                subscriberCount: parseInt(subscriberFilter.value),
                ratio: parseFloat(ratioFilter.value)
            };

            showLoading(true);
            showMessage("YouTube API 호출 중...", "info");

            try {
                // (중요) Google API가 아닌, 우리 자신의 Vercel 백엔드(/api/youtube)로 요청을 보냅니다.
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // 3. 'publishedAfter'를 API로 전송
                    body: JSON.stringify({ keyword, publishedAfter, maxResults })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                const videos = await response.json();
                
                // 3, 4, 6. 클라이언트 측 필터링 후 결과 표시
                displayResults(videos, filters);

            } catch (error) {
                showMessage(`오류 발생: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        });

        // --- 1.2. 검색 결과 표시 (필터링 로직 추가) ---
        function displayResults(videos, filters) {
            resultsBody.innerHTML = ''; // 테이블 비우기

            // 3, 4, 6. 클라이언트 측 필터링 로직
            const filteredVideos = videos.filter(video => {
                const viewCount = parseInt(video.viewCount || 0);
                const subCount = parseInt(video.subscriberCount || 0);
                const ratio = subCount > 0 ? (viewCount / subCount) : 0;

                // 3. 조회수 필터
                if (viewCount < filters.viewCount) {
                    return false;
                }
                
                // 4. 구독자수 필터
                if (filters.subscriberCount !== -1) { // -1은 '전체'
                    if (filters.subscriberCount === 99999) { // 10만 미만
                        if (subCount >= 100000) return false;
                    } else { // 10만 이상, 50만 이상...
                        if (subCount < filters.subscriberCount) return false;
                    }
                }
                
                // 6. 비율 필터
                if (ratio < filters.ratio) {
                    return false;
                }

                return true; // 모든 필터 통과
            });
            
            // 필터링된 결과 메시지
            showMessage(`검색 완료. 총 ${videos.length}개 중 ${filteredVideos.length}개 표시.`, "success");

            filteredVideos.forEach(video => {
                const tr = document.createElement('tr');
                // 6. hover 색상 변경
                tr.classList.add('hover:bg-gray-100');
                
                // 데이터를 tr의 dataset에 저장 (나중에 분석용)
                tr.dataset.videoId = video.videoId;
                tr.dataset.title = video.title;
                tr.dataset.description = video.description;
                // 11. 정렬을 위한 데이터 저장
                tr.dataset.channel = video.channelTitle;
                tr.dataset.views = video.viewCount;
                tr.dataset.subs = video.subscriberCount;
                tr.dataset.published = video.publishedAt;
                
                // 4. 비율 계산
                const viewCount = parseInt(video.viewCount || 0);
                const subCount = parseInt(video.subscriberCount || 0);
                const ratio = subCount > 0 ? (viewCount / subCount) : 0;
                tr.dataset.ratio = ratio;

                tr.innerHTML = `
                    <td class="p-3"><input type="checkbox" class="result-checkbox bg-gray-200 border-gray-300 rounded w-6 h-6"></td>
                    <td class="p-3"><img src="${video.thumbnail}" alt="Thumbnail" class="w-full h-auto rounded"></td>
                    <td class="p-3 whitespace-normal">${video.title}</td>
                    <td class="p-3">${video.channelTitle}</td>
                    <td class="p-3">${viewCount.toLocaleString()}회</td>
                    <td class="p-3">${subCount.toLocaleString()}명</td>
                    <td class="p-3">${ratio.toFixed(1)}x</td>
                    <td class="p-3">${new Date(video.publishedAt).toLocaleDateString()}</td>
                    <td class="p-3 w-24"><a href="${video.videoUrl}" target="_blank" class="text-blue-600 hover:underline">링크</a></td>
                `;
                resultsBody.appendChild(tr);
            });
        }
        
        // --- 1.3. 전체 선택 ---
        selectAllCheckbox.addEventListener('click', () => {
            document.querySelectorAll('.result-checkbox').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        });

        // --- 2. [핵심 주제 및 소재] 분석 로직 (단순화) ---
        processSelectedButton.addEventListener('click', async () => {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                showMessage("먼저 분석할 영상을 1개 이상 선택하세요.", "error");
                return;
            }

            showLoading(true);
            analysisBody.innerHTML = ''; // 분석 테이블 비우기
            showMessage(`총 ${selectedRows.length}개 항목 분석 시작...`);

            // 한 번에 하나씩 순차 처리 (API 과부하 방지)
            for (const row of selectedRows) {
                const { title, description } = row.dataset; 
                let analysisData = null;

                try {
                    // --- A. AI 주제 분석 ---
                    showMessage(`"${title}" 영상 AI 분석 중...`);
                    const analyzeResponse = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: `제목: ${title}\n설명: ${description}` })
                    });
                    
                    if (!analyzeResponse.ok) {
                        const err = await analyzeResponse.json();
                        throw new Error(err.error || 'AI 분석 API 호출 실패');
                    }
                    analysisData = await analyzeResponse.json(); // { topic_material: "..." }

                    // --- C. 결과 테이블에 행 추가 ---
                    const analysisTR = document.createElement('tr');
                    analysisTR.innerHTML = `
                        <td class="p-3">${title}</td>
                        <td class="p-3">${analysisData.topic_material}</td>
                    `;
                    analysisBody.appendChild(analysisTR);
                    
                } catch (error) {
                    // 오류가 발생해도 다음 행은 계속 처리
                    showMessage(`"${title}" 처리 중 오류: ${error.message}`, "error");
                    const errorTR = document.createElement('tr');
                    errorTR.innerHTML = `
                        <td class="p-3">${title}</td>
                        <td class="p-3"><span class="text-red-600">오류: ${error.message}</span></td>
                    `;
                    analysisBody.appendChild(errorTR);
                }
            }
            showMessage("모든 선택 항목 처리 완료.", "success");
            showLoading(false);
        });

        // 12. 업체 리스트 포맷팅 헬퍼 (제거됨)

        // --- 헬퍼 함수 ---
        function getSelectedRows() {
            return Array.from(document.querySelectorAll('.result-checkbox:checked'))
                        .map(cb => cb.closest('tr'));
        }
        
        // --- 11. 테이블 정렬 (JS 기반) ---
        // 정렬 상태를 저장할 변수
        let sortDirections = {};

        function sortTable(columnIndex) {
            const tableBody = document.getElementById('resultsBody');
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            
            // 현재 정렬 방향 결정 (기본: 내림차순)
            const currentDirection = sortDirections[columnIndex] || 'desc';
            const newDirection = currentDirection === 'desc' ? 'asc' : 'desc';
            sortDirections[columnIndex] = newDirection;

            // 정렬 기준이 되는 dataset key
            const keys = [
                null, // 0. 체크박스
                null, // 1. 썸네일
                'title', // 2. 제목
                'channel', // 3. 채널명
                'views', // 4. 조회수
                'subs', // 5. 구독자
                'ratio', // 6. 비율
                'published', // 7. 게시일
                null // 8. 링크
            ];
            const sortKey = keys[columnIndex];
            if (!sortKey) return; // 정렬 불가능한 열

            // 헤더 화살표 업데이트
            updateSortArrows(columnIndex, newDirection);
            
            rows.sort((a, b) => {
                const aVal = a.dataset[sortKey];
                const bVal = b.dataset[sortKey];

                let compareVal = 0;
                
                // 숫자/날짜 vs 문자열 구분
                if (sortKey === 'views' || sortKey === 'subs' || sortKey === 'ratio') {
                    compareVal = parseFloat(aVal) - parseFloat(bVal);
                } else if (sortKey === 'published') {
                    compareVal = new Date(aVal) - new Date(bVal);
                } else {
                    compareVal = aVal.localeCompare(bVal); // 문자열
                }

                return newDirection === 'asc' ? compareVal : -compareVal;
            });

            // 정렬된 행을 다시 삽입
            tableBody.innerHTML = '';
            rows.forEach(row => tableBody.appendChild(row));
        }
        
        function updateSortArrows(activeIndex, direction) {
            const headers = document.querySelectorAll("#resultsTable thead th");
            headers.forEach((th, index) => {
                // 6. hover 색상에 맞게 헤더 화DNI 텍스트 유지
                let textContent = th.textContent;
                if (th.onclick) {
                    textContent = th.textContent.replace(' ▼', '').replace(' ▲', '');
                    if (index === activeIndex) {
                        textContent += (direction === 'asc' ? ' ▲' : ' ▼');
                    } else {
                        textContent += ' ▼'; // 기본값
                    }
                }
                th.textContent = textContent;
            });
        }

    </script>
</body>
</html>
