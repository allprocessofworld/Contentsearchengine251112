<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°ì—… ë‹¤í ë¦¬ì„œì¹˜ íˆ´</title>
    <!-- 1. Tailwind CSS (CDN) ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* í…Œì´ë¸” ì…€ì´ ê¹¨ì§€ì§€ ì•Šë„ë¡ */
        td {
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-blue-400 mb-6">ğŸ­ ì‚°ì—… ë‹¤í ë¦¬ì„œì¹˜ íˆ´ (Web Program Ver.)</h1>

        <!-- 1. ê²€ìƒ‰ ì˜ì—­ -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-white">1. YouTube ì˜ìƒ ê²€ìƒ‰</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="keywordInput" placeholder="ê²€ìƒ‰ í‚¤ì›Œë“œ (ì˜ˆ: ìŠ¤ë§ˆíŠ¸íŒ©í† ë¦¬)" class="bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="publishedAfterInput" placeholder="ì—…ë¡œë“œ ë‚ ì§œ (YYYY-MM-DD)" onfocus="(this.type='date')" onblur="(this.type='text')" class="bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" id="maxResultsInput" placeholder="ê²€ìƒ‰í•  ì˜ìƒ ìˆ˜ (ìµœëŒ€ 50)" value="20" class="bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button id="searchButton" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                ê²€ìƒ‰ ì‹¤í–‰
            </button>
        </div>

        <!-- ê³µí†µ ë©”ì‹œì§€ ë° ë¡œë”© ì˜ì—­ -->
        <div id="loadingIndicator" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
            <p class="text-white text-lg mt-4 text-center">ì²˜ë¦¬ ì¤‘...</p>
        </div>
        <div id="messageBox" class="hidden p-4 mb-4 text-sm text-yellow-300 bg-yellow-900 rounded-lg" role="alert"></div>

        <!-- 2. ìœ íŠœë¸Œ ê²€ìƒ‰ ê²°ê³¼ -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-xl font-semibold mb-4 text-white">2. YouTube ê²€ìƒ‰ ê²°ê³¼</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="resultsTable">
                    <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-3"><input type="checkbox" id="selectAllCheckbox"></th>
                            <th class="p-3 cursor-pointer" onclick="sortTable(1)">ì œëª©</th>
                            <th class="p-3 cursor-pointer" onclick="sortTable(2)">ì±„ë„ëª…</th>
                            <th class="p-3 cursor-pointer" onclick="sortTable(3)">ì¡°íšŒìˆ˜</th>
                            <th class="p-3 cursor-pointer" onclick="sortTable(4)">ê²Œì‹œì¼</th>
                            <th class="p-3">ë§í¬</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody" class="divide-y divide-gray-700">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 3. ë¶„ì„ ë° ì„­ì™¸ -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4 text-white">3. ì£¼ì œ ë¶„ì„ ë° ì—…ì²´ ì„­ì™¸ ë¦¬ìŠ¤íŠ¸</h2>
            <div class="flex gap-4 mb-4">
                <button id="analyzeButton" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                    ì„ íƒí•œ ì˜ìƒ [ì£¼ì œ ë¶„ì„] (AI)
                </button>
                <button id="companySearchButton" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow transition duration-300">
                    ì„ íƒí•œ ì˜ìƒ [ì—…ì²´ ê²€ìƒ‰] (Google)
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left" id="analysisTable">
                    <thead class="bg-gray-700 text-gray-300 uppercase text-sm">
                        <tr>
                            <th class="p-3">ì˜ìƒ ì œëª©</th>
                            <th class="p-3">AI ë¶„ì„ - í•µì‹¬ ì£¼ì œ</th>
                            <th class="p-3">AI ë¶„ì„ - ê´€ë ¨ ì‚°ì—…/ì—…ì¢…</th>
                            <th class="p-3">ì„­ì™¸ ëŒ€ìƒ ê¸°ì—… (Top 5)</th>
                        </tr>
                    </thead>
                    <tbody id="analysisBody" class="divide-y divide-gray-700">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. Vanilla JavaScript (Client Logic) -->
    <script>
        // --- DOM ìš”ì†Œ ---
        const keywordInput = document.getElementById('keywordInput');
        const publishedAfterInput = document.getElementById('publishedAfterInput');
        const maxResultsInput = document.getElementById('maxResultsInput');
        const searchButton = document.getElementById('searchButton');
        const resultsBody = document.getElementById('resultsBody');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const analyzeButton = document.getElementById('analyzeButton');
        const companySearchButton = document.getElementById('companySearchButton');
        const analysisBody = document.getElementById('analysisBody');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
        }

        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.classList.remove('hidden');
            // ìƒ‰ìƒ ë³€ê²½ (ë‚˜ì¤‘ì— ì¶”ê°€)
        }

        // --- 1. YouTube ê²€ìƒ‰ (Backend API í˜¸ì¶œ) ---
        searchButton.addEventListener('click', async () => {
            const keyword = keywordInput.value;
            const publishedAfter = publishedAfterInput.value ? new Date(publishedAfterInput.value).toISOString() : null;
            const maxResults = maxResultsInput.value;

            if (!keyword) {
                showMessage("ê²€ìƒ‰ í‚¤ì›Œë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.", "error");
                return;
            }

            showLoading(true);
            showMessage("YouTube API í˜¸ì¶œ ì¤‘...", "info");

            try {
                // (ì¤‘ìš”) Google APIê°€ ì•„ë‹Œ, ìš°ë¦¬ ìì‹ ì˜ Vercel ë°±ì—”ë“œ(/api/youtube)ë¡œ ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
                const response = await fetch('/api/youtube', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, publishedAfter, maxResults })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error);
                }

                const videos = await response.json();
                
                // (ê²½ê³ ) ìš”ì²­í•˜ì‹  ë³µì¡í•œ í•„í„°(êµ¬ë…ì, ìˆí¼/ë¡±í¼)ëŠ” API í• ë‹¹ëŸ‰(Quota)ì„ 
                // í­ë°œì‹œí‚¤ë¯€ë¡œ ì˜ë„ì ìœ¼ë¡œ 'ì œì™¸'í–ˆìŠµë‹ˆë‹¤. 
                // ëŒ€ì‹ , ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ HTML í…Œì´ë¸”ì—ì„œ 'ì •ë ¬'í•˜ëŠ” ê¸°ëŠ¥ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
                
                displayResults(videos);
                showMessage("ê²€ìƒ‰ ì™„ë£Œ.", "success");

            } catch (error) {
                showMessage(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, "error");
            } finally {
                showLoading(false);
            }
        });

        // --- 1.2. ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ---
        function displayResults(videos) {
            resultsBody.innerHTML = ''; // í…Œì´ë¸” ë¹„ìš°ê¸°
            videos.forEach(video => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-700');
                
                // ë°ì´í„°ë¥¼ trì˜ datasetì— ì €ì¥ (ë‚˜ì¤‘ì— ë¶„ì„ìš©)
                tr.dataset.videoId = video.videoId;
                tr.dataset.title = video.title;
                tr.dataset.description = video.description;
                
                tr.innerHTML = `
                    <td class="p-3"><input type="checkbox" class="result-checkbox bg-gray-600 rounded"></td>
                    <td class="p-3">${video.title}</td>
                    <td class="p-3">${video.channelTitle}</td>
                    <td class="p-3">${parseInt(video.viewCount || 0).toLocaleString()}</td>
                    <td class="p-3">${new Date(video.publishedAt).toLocaleDateString()}</td>
                    <td class="p-3"><a href="${video.videoUrl}" target="_blank" class="text-blue-400 hover:underline">ë§í¬</a></td>
                `;
                resultsBody.appendChild(tr);
            });
        }
        
        // --- 1.3. ì „ì²´ ì„ íƒ ---
        selectAllCheckbox.addEventListener('click', () => {
            document.querySelectorAll('.result-checkbox').forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
        });

        // --- 2. ì„ íƒ ì˜ìƒ [ì£¼ì œ ë¶„ì„] (Backend API í˜¸ì¶œ) ---
        analyzeButton.addEventListener('click', async () => {
            const selectedRows = getSelectedRows();
            if (selectedRows.length === 0) {
                showMessage("ë¨¼ì € ë¶„ì„í•  ì˜ìƒì„ ì„ íƒí•˜ì„¸ìš”.", "error");
                return;
            }

            showLoading(true);
            analysisBody.innerHTML = ''; // ë¶„ì„ í…Œì´ë¸” ë¹„ìš°ê¸°

            for (const row of selectedRows) {
                const { title, description } = row.dataset;
                showMessage(`"${title}" ì˜ìƒ AI ë¶„ì„ ì¤‘...`);
                
                try {
                    // (ì¤‘ìš”) Gemini APIê°€ ì•„ë‹Œ, ìš°ë¦¬ ìì‹ ì˜ Vercel ë°±ì—”ë“œ(/api/analyze)ë¡œ ìš”ì²­
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: `ì œëª©: ${title}\nì„¤ëª…: ${description}` })
                    });
                    
                    if (!response.ok) throw new Error('AI ë¶„ì„ API í˜¸ì¶œ ì‹¤íŒ¨');
                    
                    const data = await response.json(); // { topics: [], industries: [] }
                    
                    // ë¶„ì„ í…Œì´ë¸”ì— í–‰ ì¶”ê°€
                    const analysisTR = document.createElement('tr');
                    analysisTR.dataset.title = title; // ê¸°ì—… ê²€ìƒ‰ì„ ìœ„í•´ ì €ì¥
                    analysisTR.dataset.industries = data.industries.join(', '); // ê¸°ì—… ê²€ìƒ‰ì„ ìœ„í•´ ì €ì¥
                    analysisTR.innerHTML = `
                        <td class="p-3">${title}</td>
                        <td class="p-3">${data.topics.join(', ')}</td>
                        <td class="p-3">${data.industries.join(', ')}</td>
                        <td class="p-3" id="company-cell-${row.dataset.videoId}"></td>
                    `;
                    analysisBody.appendChild(analysisTR);
                    
                } catch (error) {
                    showMessage(`"${title}" ë¶„ì„ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "error");
                }
            }
            showMessage("AI ë¶„ì„ ì™„ë£Œ.", "success");
            showLoading(false);
        });

        // --- 3. ì„ íƒ ì˜ìƒ [ì—…ì²´ ê²€ìƒ‰] (Backend API í˜¸ì¶œ) ---
        companySearchButton.addEventListener('click', async () => {
            // (ì£¼ì˜) ì´ ë²„íŠ¼ì€ 'ë¶„ì„ í…Œì´ë¸”'ì— ìˆëŠ” ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
            const analysisRows = Array.from(analysisBody.querySelectorAll('tr'));
            if (analysisRows.length === 0) {
                showMessage("ë¨¼ì € [ì£¼ì œ ë¶„ì„]ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.", "error");
                return;
            }

            showLoading(true);

            for (const row of analysisRows) {
                const industryQuery = row.dataset.industries;
                const title = row.dataset.title;
                const videoId = title.replace(/\s/g, '-').substring(0, 10); // ì„ì‹œ ID
                
                if (!industryQuery) continue;
                
                showMessage(`"${industryQuery}" ê´€ë ¨ ê¸°ì—… ê²€ìƒ‰ ì¤‘...`);
                
                try {
                    // (ê²½ê³ ) ì´ë©”ì¼/ì „í™”ë²ˆí˜¸ ìŠ¤í¬ë˜í•‘ì€ ë¶ˆë²•/ë¶ˆì•ˆì •í•˜ë¯€ë¡œ 'í¬ê¸°'í•©ë‹ˆë‹¤.
                    // ëŒ€ì‹  'Google Search API'ë¡œ ê¸°ì—…ëª…ê³¼ 'í™ˆí˜ì´ì§€'ë§Œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
                    // (ì¤‘ìš”) Google APIê°€ ì•„ë‹Œ, ìš°ë¦¬ ìì‹ ì˜ Vercel ë°±ì—”ë“œ(/api/company)ë¡œ ìš”ì²­
                    const response = await fetch('/api/company', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: `${industryQuery.split(',')[0]} ëŒ€í•œë¯¼êµ­ ì œì¡° ê¸°ì—…` })
                    });

                    if (!response.ok) throw new Error('ê¸°ì—… ê²€ìƒ‰ API í˜¸ì¶œ ì‹¤íŒ¨');

                    const data = await response.json(); // { companies: [] }
                    const cell = row.querySelector(`td:last-child`); // ë§ˆì§€ë§‰ ì…€
                    
                    if (data.companies && data.companies.length > 0) {
                        cell.innerHTML = data.companies.map(c => 
                            `<div><a href="${c.link}" target="_blank" class="text-blue-400 hover:underline">${c.title}</a></div>`
                        ).join('');
                    } else {
                        cell.innerHTML = 'ê²€ìƒ‰ëœ ê¸°ì—… ì—†ìŒ';
                    }

                } catch (error) {
                     showMessage(`"${title}" ê¸°ì—… ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "error");
                }
            }
            showMessage("ê¸°ì—… ê²€ìƒ‰ ì™„ë£Œ. ìˆ˜ë™ ì—°ë½ì²˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.", "success");
            showLoading(false);
        });


        // --- í—¬í¼ í•¨ìˆ˜ ---
        function getSelectedRows() {
            return Array.from(document.querySelectorAll('.result-checkbox:checked'))
                        .map(cb => cb.closest('tr'));
        }
        
        // --- í…Œì´ë¸” ì •ë ¬ (JS ê¸°ë°˜) ---
        function sortTable(n) {
            // (êµ¬í˜„ ìƒëµ) - ì´ ë¶€ë¶„ì€ ì´ˆë³´ìê°€ êµ¬í˜„í•˜ê¸° ë³µì¡í•©ë‹ˆë‹¤.
            // ìš°ì„ ìˆœìœ„ì—ì„œ ì œì™¸í•©ë‹ˆë‹¤. 
            // 10ì–µ ì—°ë´‰ ê°œë°œìëŠ” í•µì‹¬ ê¸°ëŠ¥(API ì—°ë™)ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.
            showMessage(`í…Œì´ë¸” ${n}ì—´ ì •ë ¬ (ê¸°ëŠ¥ êµ¬í˜„ í•„ìš”)`);
        }

    </script>
</body>
</html>
